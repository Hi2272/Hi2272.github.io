<!DOCTYPE html>
<html>

<head>
  <script src="https://unpkg.com/konva@8.2.3/konva.min.js"></script>
  <meta charset="utf-8" />
  <title>Stoffe und Teilchen</title>
  <link rel="stylesheet" href="Style.css">
</head>

<body>
  <header>
    Ziehe die Textbausteine in folgendes Diagramm. <br>
    <button id="Button" onClick="pruefen()" style="visibility: hidden;">Prüfen</button>

  </header>
  <section>
    <div id="container"></div>
  </section>
  <footer>
    <div id="ausgabe">
    </div>
  </footer>

  <script>
    var dateiname = "Datenfluss.png";
    var copyright = "Quelle des Bildes: eigene Zeichnung, Rainer Hille 2021";
    var snap = true;   // snap = true -> Abfrage-Modus
    // var snap = false;    // snap = false -> Programmier-Modus, Koordinaten werden ausgegeben

    var nummer = 0;    // 
    var width = window.innerWidth;
    var height = window.innerHeight;


    var stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height,
    });

    var layer = new Konva.Layer();
    var layerText = new Konva.Layer();

    var txt = [
      // Hier die Textbausteine einfügen
      { x: 0.236, y: 0.514, text: 'WAHR/FALSCH', pos: [0] },
      { x: 0.565, y: 0.5, text: 'Falsch-Alternative', pos: [1] },
      { x: 0.395, y: 0.512, text: 'Wahr-Alternative', pos: [2] },
      { x: 0.402, y: 0.718, text: 'WENN', pos: [3] },
      { x: 0.23, y: 0.293, text: '=', pos: [4] },
      { x: 0.102, y: 0.033, text: 'D1', pos: [5, 6] },
      { x: 0.341, y: 0.027, text: '"g"', pos: [5, 6] },
      { x: 0.652, y: 0.262, text: '0.19', pos: [7] },
      { x: 0.444, y: 0.271, text: '0', pos: [8] },
      { x: 0.423, y: 0.921, text: 'E2', pos: [9] }
    ];

    textCopyRight = new Konva.Text({
      x: width*0.8+5,   // y wird später ersetzt
      width: width*0.2,
      fill: 'blue',
      fontSize: 9,
      text: copyright,
    });
    layerText.add(textCopyRight);

    var text = new Array();
    for (i = 0; i < txt.length; i++) {
      text[i] = new Konva.Text({
        x: width * 0.8 + 5,
        width: width*0.2,
        text: txt[i].text,
        fill: 'blue',
        fontSize: 4 + Math.round(width / 80),
      });
      text[i].y(i * text[i].height() * 2);
      text[i].draggable('true');
      layerText.add(text[i]);
      text[i].on('dragend', function (e) {
        /*
        Funktion, die beim Ende des Drag-Vorgangs aufgerufen wird
        */
        var obj = e.target;
        var x = Math.round(obj.x() / layer.width() * 1000) / 1000;
        var y = Math.round(obj.y() / layer.height() * 1000) / 1000;
        if (!snap) {    // snap false => Koordinaten ausgeben
          document.getElementById("ausgabe").innerHTML = document.getElementById("ausgabe").innerHTML +
            "<br>" + "{x:" + x + ",y:" + y + ",text:'" + obj.text() + "',pos:[" + nummer + "]},";
          nummer++;
        } else {   // snap true => Texte auf die nächstliegende Koordinate schieben
          if (x < 0.8) {   // Snap-Funktion gilt nicht, wenn die Karte nach rechts gezogen
            var n = 9999;
            var mindist = layer.width() * layer.width() + layer.height() * layer.height();
            for (i = 0; i < txt.length; i++) {
              dist = (x - txt[i].x) * (x - txt[i].x) + (y - txt[i].y) * (y - txt[i].y);
              if (dist < mindist) {
                mindist = dist;
                n = i;
              }
            }
            if (n != 9999) {  // Hier wird auf die Koordinaten geschoben
              this.x(txt[n].x * layer.width());
              this.y(txt[n].y * layer.height());
            } else {
              console.log("Objekt nicht gefunden!");
            }
          }
          var alle = true;
          for (i = 0; i < text.length; i++) {
            if (text[i].x() / layer.width() > 0.8) {
              alle = false;
              i = 99;
            }
          }
          if (alle) {
            console.log("True");
            document.getElementById("Button").style.visibility = "visible";
          }

        }
      });
    }

    var imageObj = new Image();
    imageObj.onload = function () {
      console.log("Ausrichtungstest");
      if (width < height) {
        alert("Die Seite ist auf eine Darstellung in Querformat optimiert.\n" +
          "Bitte drehen Sie Ihr Gerät und laden Sie die Seite neu!");
      }

      console.log(layer.width() + " " + layer.height());
      var img = new Konva.Image({
        x: 0,
        y: 0,
        image: imageObj,
      });

      // Bild auf 80% der Seitenbreite vergrößern
      var w = img.width();
      var h = img.height();
      var f = layer.width() * 0.8 / w;  // Vergrößerungsfaktor 

      img.width(f * w);
      img.height(f * h);

      stage.height(img.height());  // Höhe der Zeichenflaeche anpassen

      textCopyRight.y(stage.height()-20);
      // add the shape to the layer
      layer.add(img);

    };
    imageObj.src = dateiname;


    // add the layer to the stage
    stage.add(layer);
    stage.add(layerText);

    function pruefen() {
      var anzGefunden = 0;
      console.log("Prüfung");
      for (i1 = 0; i1 < text.length; i1++) { // Alle Textbausteine durchlaufen
        var t1 = text[i1];
        gefunden = false;
        for (i2 = 0; i2 < txt.length; i2++) {
          var t2 = txt[i2];
          if (t2.text == t1.text()) {  // Text stimmt überein
            console.log(t1.text());
            for (i3 = 0; i3 < t2.pos.length; i3++) {  // Alle alternativen Positionen durchlaufen
              console.log(i3);
              var t3 = txt[t2.pos[i3]];
              var dx = Math.abs(t1.x() - t3.x * layer.width());
              var dy = Math.abs(t1.y() - t3.y * layer.height());
              console.log(t1.text() + " " + t3.text + " " + dx + " " + dy)
              if (dx < 2 && dy < 2) {
                gefunden = true;
                t1.fill('green');
                anzGefunden++;
              } else if (!gefunden) {
                t1.fill('red');
              }
            }
          }
        }
      }
      if (anzGefunden == text.length) {
        alert("Super, du hast die Aufgabe vollständig gelöst!");
      } else {
        alert("Die grünen Begriffe sind richtig - die roten musst du noht korrigieren!");
      }
    }


  </script>
</body>

</html>
